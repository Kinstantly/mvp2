.search_results
	%h1= search_results_title @search, @search_area_tag_id
	- if @search.results.present?
		.search_results_options
			= form_tag search_providers_path, method: :get, id: 'nearest_to_city_postal_code_form' do
				= hidden_field_tag :query, @search_query
				= hidden_field_tag :search_area_tag_id, @search_area_tag_id
				= t 'views.search_results.nearest_to_city_postal_code'
				- city_prompt = t 'views.search_results.city_prompt'
				/[if lt IE 9]
					= city_prompt
				= text_field_tag :city, @search_city, size: 12, id: 'search_city', placeholder: city_prompt, title: city_prompt
				= hidden_field_tag :region, DEFAULT_REGION
				= t 'views.or'
				- postal_code_prompt = t 'views.search_results.postal_code_prompt'
				/[if lt IE 9]
					= postal_code_prompt
				= text_field_tag :postal_code, @search_postal_code, size: 10, id: 'search_postal_code', placeholder: postal_code_prompt, title: postal_code_prompt
				= submit_tag 'Show', disable_with: 'Show...', id: 'order_by_distance_button'
			#get_location_button_area{style: 'display: none'}
				= form_tag '#' do
					= t 'views.search_results.nearest_to_you'
					= submit_tag 'Nearest', id: 'get_location_button'
			- if @search_latitude && @search_longitude
				#nearest_results_msg= t 'views.search_results.nearest_results_msg', page: @search_page
	.search_results_list#content
		- @search.results.each_with_index do |profile, i|
			- profile_id = "profile_#{i}"
			%article.search_result.clearfix{itemscope: "", itemtype: "http://schema.org/Person", id: "search_result_#{i}"}
				.short-profile{id: profile_id}
					.popover
						.profile-photo-placeholder
						.profile
							%h1{itemprop: "name"}
								= profile.display_name_or_company
								- if profile.headline.present?
									%span.headline= profile.headline
							%span.specialties= search_result_specialties profile
							- location = profile.locations.order_by_id.first
							%span
								%span.location{itemprop: "street-address"}
									= location.try(:display_address)
									- if (location_count = profile.locations.count) > 1
										= t 'views.location.view.more.how_many', count: (location_count - 1)
								%span.location{itemprop: "telephone"}= location.try(:display_phone)
							%span
								%span.location{itemprop: "url"}= profile_display_website profile
								- if profile.email.present?
									%span.location{itemprop: "email"}
										= t 'views.profile.view.email'
										= profile_display_email profile
						.summary
							%span.text_area= profile_display_text profile.summary, preserve: true
				-# = image_tag 'profile-photo-placeholder.jpg', alt: "#{profile.display_name_or_company}", width: '168', height: '168', border: '0', class: 'profile-photo', itemprop: 'image'
				.profile-photo-placeholder
				.profile
					%h1.show_profile{itemprop: "name", 'data-profile-id' => profile_id}
						= profile_list_name_or_company_link profile, class: 'open'
						- if profile.headline.present?
							%span.headline= profile.headline
					%span.specialties= search_result_specialties_truncated profile
					%span.location{itemprop: "street-address"}= search_result_location profile
					%span.summary
						= profile_display_truncated profile.summary, length: 200, links: true
						= link_to t('views.search_results.more'), profile_path(profile), class: 'open'
				.rating-contact
					= render partial: 'profiles/rating_score', locals: {profile: profile}
					%ul.contact-toolbar
						%li.consult_by_email= profile_consult_by_email_element profile
						%li.consult_by_phone= profile_consult_by_phone_element profile
						%li.consult_by_video= profile_contact_icon_element :consult_by_video, profile
						%li.consult_in_person= profile_contact_icon_element :consult_in_person, profile
						%li.consult_in_group= profile_contact_icon_element :consult_in_group, profile
						%li.visit_home= profile_contact_icon_element :visit_home, profile
						%li.visit_school= profile_contact_icon_element :visit_school, profile
						%li.consult_at_hospital= profile_contact_icon_element :consult_at_hospital, profile
						%li.consult_at_camp= profile_contact_icon_element :consult_at_camp, profile
						%li.consult_at_other= profile_contact_icon_element :consult_at_other, profile
						%li.appointment
							%a{href: "#"} Make an appointment
		- if @search.results.present?
			.search_result= paginate @search.results

-# Interpolate in javascript.  HAML cannot cache coffeescript with embedded ruby interpolation!
:javascript
	var my_vars = {
		search_path: '#{escape_javascript search_providers_path(query: @search_query, search_area_tag_id: @search_area_tag_id)} .search_result',
		t: {
			searching: '#{t "views.search_results.searching"}',
			showing_nearest_to_you: '#{t "views.search_results.showing_nearest_to_you"}'
		}
	};

:coffeescript
	if Modernizr.geolocation
		$('#get_location_button_area').css('display', 'inline-block')
	$('#search_city').focusin ->
		$('#search_postal_code').val('')
	$('#search_postal_code').focusin ->
		$('#search_city').val('')
	$('#get_location_button').click (e) ->
		e.preventDefault()
		$('#get_location_button_area').html(my_vars.t.searching)
		if Modernizr.geolocation
			navigator.geolocation.getCurrentPosition(search_by_location)
	search_by_location = (position) ->
		params = 'latitude='+position.coords.latitude+'&longitude='+position.coords.longitude
		$('.search_results_list').load(my_vars.search_path, params, search_by_location_complete)
	search_by_location_complete = ->
		window.rating_score_reset() if window.rating_score_reset
		$('#get_location_button_area').html(my_vars.t.showing_nearest_to_you)
		$('#nearest_results_msg').remove()
		window.link_short_profiles()
	event_is_over_element = (e, el) ->
		el_coords = el.offset()
		e.pageY > el_coords.top && e.pageY < el_coords.top + el.outerHeight() &&
			e.pageX > el_coords.left && e.pageX < el_coords.left + el.outerWidth()
	# Pop-up short profiles
	window.link_short_profiles = ->
		$('.show_profile').mouseenter (e) ->
			short_profile = $('#' + $(this).attr('data-profile-id'))
			short_profile.css('top', $(this).height() + 8) # first try placing below the mouse-over area
			# next see if the short profile is entirely within the viewport
			win = $(window)
			viewport_top = win.scrollTop()
			viewport_bottom = viewport_top + win.height()
			popover_height = $('.popover', short_profile).outerHeight() # only the popover DIV has the proper height
			if short_profile.offset().top + popover_height > viewport_bottom # off the bottom of the viewport?
				short_profile.css('top', -(popover_height + 12)) # place above the mouse-over area
				if short_profile.offset().top < viewport_top # are we now off the top of the viewport?
					short_profile.offset({top: viewport_top + 4, left: short_profile.offset().left}) # place below top of viewport
					my_vars.on_popover = event_is_over_element e, $('.popover', short_profile) # pointer might be on the popover!
			short_profile.addClass 'active' # make it appear
			false
		$('.show_profile').mouseleave ->
			$('#' + $(this).attr('data-profile-id')).removeClass 'active' unless my_vars.on_popover
			false
		$('.short-profile').mouseleave ->
			my_vars.on_popover = false
			$(this).removeClass 'active'
			false
	window.link_short_profiles()
