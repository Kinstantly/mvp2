- profile ||= @profile
- country = default_profile_country if country.blank?
.profile_areas
	.basic_profile
		.name
			Name
			%br
			.text_field
				= f.label :first_name, 'First name'
				= f.text_field :first_name, id: 'profile_first_name', class: 'display_name_field'
			.text_field
				= f.label :middle_name, 'Middle name or initial'
				= f.text_field :middle_name, id: 'profile_middle_name', class: 'display_name_field'
			.text_field
				= f.label :last_name, 'Last name'
				= f.text_field :last_name, id: 'profile_last_name', class: 'display_name_field'
			.text_field
				= f.label :credentials, "Degrees/credentials"
				= f.text_field :credentials, id: 'profile_credentials', class: 'display_name_field'
		.display_name_area
			Display name
			%span.display_name
				= profile_display_name profile
		.email
			= f.label :email, "Public email"
			= f.text_field :email
		.company_name
			= f.label :company_name, 'Company name'
			= f.text_field :company_name
		.url
			= f.label :url, 'Website'
			= f.text_field :url
		.headline
			= f.label :headline, "Professional headline as you'd like it to appear"
			= f.text_field :headline, size: 50
		.mobile_phone
			= f.label :mobile_phone, "Mobile"
			= f.text_field :mobile_phone
		.office_phone
			= f.label :office_phone, "Office"
			= f.text_field :office_phone
	= f.fields_for :locations do |lf|
		.location_contact_profile
			.address
				= lf.label :address1, "Address"
				= lf.text_field :address1
				= lf.text_field :address2
			.city_state
				= lf.label :city, "City"
				= lf.text_field :city
				= lf.label :region, "State"
				= lf.text_field :region, size: 2
			.postal_code
				= lf.label :postal_code, "Zip code"
				= lf.text_field :postal_code
				= lf.hidden_field :country, value: country
	.expertise_profile
		.categories
			= f.label :categories, "Categories", class: 'required'
			%br
			= profile_categories_hidden_field_tag(f)
			- profile_category_choices(profile).each do |category|
				.check_box
					= profile_categories_check_box_tag(profile, category, f)
					= category.name
		.custom_categories
			Additional categories
			= button_tag id: 'add_custom_categories_text_field' do
				= content_tag :strong, '+ Add'
			%br
			= profile_custom_categories_hidden_field_tag(f)
			- i = 0; profile_new_custom_categories(profile).each do |category|
				.text_field
					= profile_custom_categories_text_field_tag(profile, category.name, "#{i = i+1}", f)
			.text_field
				= profile_custom_categories_text_field_tag(profile, '', "#{i = i+1}", f)
			- @profile_custom_categories_i = i
			- @profile_custom_categories_text_field_template = profile_custom_categories_text_field_tag(profile, '', 'INDEX', f)
		.specialties
			= f.label :specialties, "Specialties"
			%br
			%span.predefined_specialties
		.custom_specialties
			Additional specialties
			= button_tag id: 'add_custom_specialties_text_field' do
				= content_tag :strong, '+ Add'
			%br
			= profile_custom_specialties_hidden_field_tag(f)
			- i = 0; profile_new_custom_specialties(profile).each do |specialty|
				.text_field
					= profile_custom_specialties_text_field_tag(profile, specialty.name, "#{i = i+1}", f)
			.text_field
				= profile_custom_specialties_text_field_tag(profile, '', "#{i = i+1}", f)
			- @profile_custom_specialties_i = i
			- @profile_custom_specialties_text_field_template = profile_custom_specialties_text_field_tag(profile, '', 'INDEX', f)
		.age_ranges
			Ages/stages of clients/children (check all that apply):
			%br
			= profile_age_ranges_hidden_field_tag(f)
			- AgeRange.all.sort_by(&:sort_index).each do |age_range|
				.check_box
					= profile_age_ranges_check_box_tag(profile, age_range, f)
					= age_range.name
	.professional_profile
		.consultations
			.check_box
				= f.check_box :consult_by_email
				= f.label :consult_by_email, "Email consultations"
			.check_box
				= f.check_box :consult_by_phone
				= f.label :consult_by_phone, "Phone consultations"
			.check_box
				= f.check_box :consult_by_video
				= f.label :consult_by_video, "Video consultations"
		.visits
			.check_box
				= f.check_box :visit_home
				= f.label :visit_home, "Home visits"
			.check_box
				= f.check_box :visit_school
				= f.label :visit_school, "School visits"
		.education
			.label_area
				= f.label :education, "Education"
			= f.text_area :education, size: '50x5'
		.certifications
			.label_area
				= f.label :certifications, "Licenses, certifications"
			= f.text_field :certifications
		.languages
			.label_area
				= f.label :languages, "Languages"
			= f.text_field :languages
		.insurance_accepted
			.label_area
				= f.label :insurance_accepted, "Health insurance accepted"
			= f.text_area :insurance_accepted, size: '50x5'
		.summary
			.label_area
				= f.label :summary, "Summary"
			= f.text_area :summary, size: '50x8'
		.rates
			.label_area
				= f.label :rates, "Rates"
				%span.note.text_area= preserve "\nExample:\n$1/minute\n$40/15 minutes\n$120/hour\nor monthly subscription"
			= f.text_area :rates, size: '50x5'
		.availability
			.label_area
				= f.label :availability, "Next available appointments"
			= f.text_area :availability, size: '50x5'
	- if current_user.admin?
		.admin_options
			= profile_publish_check_box @profile
			Check to publish
:javascript
	window.edit_user_profile = {
		categories_specialties_map: null,
		specialties_names: null,
		specialties_check_box_cache: #{profile_specialties_check_box_cache(profile, 'check_box', f).to_json},
		specialties_check_box_template: "#{escape_javascript profile_specialties_check_box(profile, '_ID_', '_NAME_', false, 'check_box', f)}"
	};
	var categories_specialties_info = #{profile_categories_specialties_info(profile).to_json};
	edit_user_profile.categories_specialties_map = categories_specialties_info[0];
	edit_user_profile.specialties_names = categories_specialties_info[1];
:coffeescript
	# Add extra text input tags for custom categories.
	profile_custom_categories_i = #{@profile_custom_categories_i}
	$('#add_custom_categories_text_field').click (e) ->
		e.preventDefault()
		$('.custom_categories').append '<div class="text_field">'+'#{escape_javascript @profile_custom_categories_text_field_template}'.replace('INDEX', String(++profile_custom_categories_i))+'</div>'
		$('.custom_categories input:last').focus()
	
	# Refresh display name as contributing input tags are modified.
	refresh_display_name = () ->
		$('.display_name').html profile_display_name($('#profile_first_name').val(), $('#profile_middle_name').val(), $('#profile_last_name').val(), $('#profile_credentials').val())
	$('.display_name_field').keyup (e) ->
		refresh_display_name()
	
	# Show specialties check boxes that belong to the checked categories.
	show_specialties_check_boxes = ->
		spec_choices = {}
		$('.categories .check_box input').each ->
			if $(this).attr('checked')
				cat_spec_ids = edit_user_profile.categories_specialties_map[$(this).val()]
				if cat_spec_ids
					spec_choices[edit_user_profile.specialties_names[spec_id]] = spec_id for spec_id in cat_spec_ids
			true
		spec_choices[spec.name] = spec.id for spec in #{profile.specialty_ids_names.to_json}
		boxes = $('.predefined_specialties')
		$('.check_box', boxes).each ->
			edit_user_profile.specialties_check_box_cache[$('input', this).val()] = this
		boxes.empty()
		boxes.append "#{escape_javascript profile_specialties_hidden_field_tag(f)}"
		spec_names = Object.keys(spec_choices)
		if spec_names.length > 0
			for name in spec_names.sort((a, b) -> a.toLowerCase().localeCompare(b.toLowerCase()))
				spec_id = spec_choices[name]
				check_box = edit_user_profile.specialties_check_box_cache[spec_id] || edit_user_profile.specialties_check_box_template.replace(/_ID_/g, spec_id).replace(/_NAME_/g, name)
				boxes.append check_box
		else
			boxes.append "#{escape_javascript content_tag(:div, 'Choose a category and we\'ll show you a list of specialties.', class: 'notice')}"
	show_specialties_check_boxes()
	# Redisplay specialties choices when categories are changed.
	$('.categories .check_box input').change (e) ->
		show_specialties_check_boxes()
	
	# Add extra text input tags for custom specialties.
	profile_custom_specialties_i = #{@profile_custom_specialties_i}
	$('#add_custom_specialties_text_field').click (e) ->
		e.preventDefault()
		$('.custom_specialties').append '<div class="text_field">'+'#{escape_javascript @profile_custom_specialties_text_field_template}'.replace('INDEX', String(++profile_custom_specialties_i))+'</div>'
		$('.custom_specialties input:last').focus()
